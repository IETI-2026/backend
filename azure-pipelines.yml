# ============================================================
# Azure DevOps Pipeline para Cameyo Backend
# ============================================================

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - README.md
      - docs/**
      - '**/*.md'

variables:
  # Azure Container Registry
  dockerRegistryServiceConnection: 'cameyoback-acr-connection'
  containerRegistry: 'cameyoback.azurecr.io'
  imageRepository: 'cameyo-backend'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'

  # Tags
  tag: '$(Build.BuildId)'
  latestTag: 'latest'

  # Node.js version
  nodeVersion: '20.x'

  # Pool
  vmImageName: 'ubuntu-latest'

stages:
  # ============================================================
  # Stage 1: Build & Test
  # ============================================================
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test Application'
        pool:
          vmImage: $(vmImageName)

        steps:
          # Checkout code
          - checkout: self
            fetchDepth: 0

          # Setup Node.js
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          # Cache node_modules
          - task: Cache@2
            displayName: 'Cache node_modules'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              path: node_modules
              cacheHitVar: CACHE_RESTORED

          # Install dependencies
          - script: |
              npm ci
            displayName: 'Install Dependencies'
            condition: ne(variables.CACHE_RESTORED, 'true')

          # Generate Prisma Client
          - script: |
              npx prisma generate
            displayName: 'Generate Prisma Client'

          # Lint
          - script: |
              npm run lint
            displayName: 'Run Linter'
            continueOnError: true

          # Build
          - script: |
              npm run build
            displayName: 'Build Application'

          # Run tests
          - script: |
              npm run test:cov
            displayName: 'Run Unit Tests'
            continueOnError: true

          # Publish test results
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit.xml'
              failTaskOnFailedTests: false

          # Publish code coverage
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish Code Coverage'
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/coverage'

  # ============================================================
  # Stage 2: Build & Push Docker Image (Production)
  # ============================================================
  - stage: BuildDockerProd
    displayName: 'Build & Push Docker Image'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: BuildDockerImage
        displayName: 'Build and Push Docker Image to ACR'
        pool:
          vmImage: $(vmImageName)

        steps:
          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: $(dockerRegistryServiceConnection)

          - task: Docker@2
            displayName: 'Build Docker Image'
            inputs:
              command: build
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(latestTag)
                $(tag)
              arguments: '--target production'

          - task: Docker@2
            displayName: 'Push Docker Image to ACR'
            inputs:
              command: push
              repository: $(imageRepository)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(latestTag)
                $(tag)

          # Security scan
          - task: AzureContainerRegistry@0
            displayName: 'Scan Docker Image for Vulnerabilities'
            inputs:
              azureSubscription: 'Azure for Students'
              azureContainerRegistry: $(containerRegistry)
              command: 'scan'
              imageName: '$(imageRepository):$(latestTag)'
            continueOnError: true
